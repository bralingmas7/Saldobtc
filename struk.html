<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Struk Pembelian</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 15px;
      background: #f5f5f5;
    }
    textarea, input, button {
      width: 100%;
      font-size: 16px;
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      box-sizing: border-box;
    }
    #struk-container {
      background: white;
      padding: 15px;
      margin-top: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #struk {
      font-family: 'Courier New', monospace;
      font-size: 16px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      text-align: left;
    }
    .btn-group {
      display: flex;
      gap: 10px;
    }
    .btn-group button {
      flex: 1;
    }
  </style>
</head>
<body>

<h2>Input Transaksi</h2>
<textarea id="input" rows="4" placeholder="Contoh:
Pulsa 10 2
Data 50"></textarea>

<input id="bayar" type="number" placeholder="Bayar (Contoh: 50 untuk 50k)">

<div class="btn-group">
  <button onclick="saveAsImage()" style="background-color: #25D366; color: white; border: none;">Simpan Gambar</button>
  <button onclick="shareToWhatsApp()" style="background-color: #25D366; color: white; border: none;">Kirim ke WhatsApp (Teks)</button>
</div>

<div id="struk-container">
  <div id="struk"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
function getHariTanggal() {
  const hariIndo = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
  const tgl = new Date();
  const hari = hariIndo[tgl.getDay()];
  const tanggal = tgl.toLocaleDateString('id-ID', {
    day: '2-digit', month: '2-digit', year: 'numeric'
  });
  const waktu = tgl.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
  return `${hari}, ${tanggal} ${waktu}`;
}

function generateStruk() {
  const input = document.getElementById("input").value;
  const bayarInput = parseInt(document.getElementById("bayar").value || "0");
  const lines = input.split('\n');
  let output = "====== STRUK ======\n";
  output += getHariTanggal() + "\n";
  output += "-------------------\n";
  let total = 0;
  let detail = "";

  // Proses item (hanya item belanja)
  lines.forEach(line => {
    const parts = line.trim().split(" ");
    if (parts.length >= 2) {
      const jenis = parts[0];
      const nominal = parseInt(parts[1]);
      const jumlah = parseInt(parts[2] || "1");
      const subtotal = nominal * 1000 * jumlah;
      total += subtotal;
      detail += `${jenis} ${nominal}K x ${jumlah} = Rp${subtotal.toLocaleString()}\n`;
    }
  });

  const bayar = bayarInput * 1000;
  const sisa = bayar - total;

  // Gabungkan semua bagian
  output += detail;
  output += "-------------------\n";
  
  // Tambahkan total, bayar, sisa dengan STYLE INLINE (untuk html2canvas)
  output += `Total: Rp${total.toLocaleString()}\n`;
  output += `Bayar: Rp${bayar.toLocaleString()}\n`;
  output += `Sisa: Rp${sisa.toLocaleString()}\n`;
  output += "===================";

  // Tampilkan di layar dengan HTML, tapi gunakan PRE dan inline style
  const htmlOutput = output.replace(/\n/g, '<br>')
    .replace(/Total: /, '<span style="color: red; font-weight: bold;">Total: </span>')
    .replace(/Bayar: /, '<span style="color: green; font-weight: bold;">Bayar: </span>')
    .replace(/Sisa: /, '<span style="color: blue; font-weight: bold;">Sisa: </span>');

  document.getElementById("struk").innerHTML = `<pre style="margin: 0; font-family: 'Courier New', monospace; font-size: 16px; line-height: 1.5;">${htmlOutput}</pre>`;

  // Simpan versi teks murni untuk WhatsApp
  window.lastStrukText = output;
}

// Auto-generate saat input berubah
document.getElementById("input").addEventListener("input", generateStruk);
document.getElementById("bayar").addEventListener("input", generateStruk);

function saveAsImage() {
  const strukElement = document.getElementById("struk-container");
  if (!strukElement.innerHTML.trim()) {
    alert("Silakan isi data transaksi terlebih dahulu!");
    return;
  }

  html2canvas(strukElement, {
    backgroundColor: '#ffffff',
    scale: 2, // Tingkatkan resolusi gambar
    useCORS: true,
    allowTaint: true
  }).then(canvas => {
    const link = document.createElement("a");
    link.download = "struk.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  });
}

function shareToWhatsApp() {
  const strukText = window.lastStrukText;
  if (!strukText) {
    alert("Silakan isi data transaksi terlebih dahulu!");
    return;
  }

  const message = encodeURIComponent(strukText);
  const whatsappUrl = `https://wa.me/?text=${message}`;

  window.open(whatsappUrl, '_blank');
}
</script>

</body>
</html>